<% layout('layouts/boilerplate') %>

<div class="row mt-3">
  <div class="col-8 offset-2">
    <h3>Edit Listing</h3>
    <form method="POST" action="/listings/<%= listing._id %>?_method=PUT" enctype="multipart/form-data" class="needs-validation" novalidate>
      
      <div class="mb-3">
        <label class="form-label">Title:</label>
        <input name="listing[title]" type="text" class="form-control" value="<%= listing.title %>" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Description:</label>
        <textarea name="listing[description]" class="form-control" required><%= listing.description %></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Price:</label>
        <input name="listing[price]" type="number" class="form-control" value="<%= listing.price %>" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Country:</label>
        <input name="listing[country]" id="country" type="text" class="form-control" value="<%= listing.country %>" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Location:</label>
        <input name="listing[location]" id="location" type="text" class="form-control" value="<%= listing.location %>" required>
      </div>

      <input type="hidden" id="latitude" name="latitude" value="<%= listing.geometry.coordinates[1] %>">
      <input type="hidden" id="longitude" name="longitude" value="<%= listing.geometry.coordinates[0] %>">

      <div class="mb-3">
        <label>Pick on Map:</label>
        <div id="map" style="height: 400px;"></div>
      </div>

      <div class="mb-3">
        <label class="form-label">Upload Image:</label>
        <input name="image" type="file" class="form-control">
      </div>

      <button class="btn btn-primary mt-3">Update Listing</button>
    </form>
  </div>
</div>

<script>
  let lat = <%= listing.geometry.coordinates[1] %>;
  let lon = <%= listing.geometry.coordinates[0] %>;

  const map = L.map('map').setView([lat, lon], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let marker = L.marker([lat, lon], {draggable: true}).addTo(map);

  function updateCoordinates(lat, lon) {
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lon;
  }

  marker.on('dragend', function(e){
    const pos = marker.getLatLng();
    updateCoordinates(pos.lat, pos.lng);
  });

  map.on('click', function(e){
    marker.setLatLng(e.latlng);
    updateCoordinates(e.latlng.lat, e.latlng.lng);
  });

  updateCoordinates(lat, lon);

  async function geocodeAddress() {
    const country = document.getElementById('country').value;
    const location = document.getElementById('location').value;
    const query = encodeURIComponent(location + ', ' + country);

    if (!query.trim()) return;

    const url = `https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1`;
    try {
      const res = await fetch(url, { headers: { "User-Agent": "wanderlust-project" } });
      const data = await res.json();

      if (data && data.length > 0) {
        const { lat, lon } = data[0];
        const newLat = parseFloat(lat);
        const newLon = parseFloat(lon);
        marker.setLatLng([newLat, newLon]);
        map.setView([newLat, newLon], 13);
        updateCoordinates(newLat, newLon);
      }
    } catch(err) {
      console.log("Geocoding error:", err);
    }
  }

  document.getElementById('country').addEventListener('change', geocodeAddress);
  document.getElementById('location').addEventListener('change', geocodeAddress);
</script>
